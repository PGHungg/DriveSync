name: Google Drive Auto Sync

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install rclone
        run: |
          curl -s https://rclone.org/install.sh | sudo bash
          rclone version | head -1

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.RCLONE_CONFIG }}' > ~/.config/rclone/rclone.conf

      - name: Sync folders
        id: sync
        run: |
          echo "Starting sync..."
          
          SUCCESS=0
          FAIL=0
          TOTAL_FILES=0
          TOTAL_BYTES=0
          FILE_LIST=""
          
          # Folder 1: 01 -> 02
          echo "========================================"
          echo "Syncing: 01 -> 02"
          LOG1="/tmp/sync1.log"
          if rclone copy "gdrive:01" "gdrive:02" \
            --exclude "*.tmp" --exclude "Thumbs.db" \
            -v --stats-one-line \
            --log-file="$LOG1" --use-json-log 2>&1; then
            SUCCESS=$((SUCCESS + 1))
            
            # Extract file details from log
            FILES1=$(grep -c '"msg":"Copied"' "$LOG1" 2>/dev/null || echo 0)
            TOTAL_FILES=$((TOTAL_FILES + FILES1))
            
            # Get file names and sizes
            if [ "$FILES1" -gt 0 ]; then
              DETAILS1=$(grep '"msg":"Copied"' "$LOG1" | jq -r '"\(.object) (\(.size // 0) bytes)"' 2>/dev/null | head -5)
              FILE_LIST="${FILE_LIST}üìÇ 01 -> 02:\n${DETAILS1}\n"
            fi
            
            echo "Success! Files: $FILES1"
          else
            FAIL=$((FAIL + 1))
            echo "Failed!"
          fi
          
          # Folder 2: C++ T10 2025 -> C++
          echo "========================================"
          echo "Syncing: C++ T10 2025 -> C++"
          LOG2="/tmp/sync2.log"
          if rclone copy "gdrive:C++ T10 2025" "gdrive:C++" \
            --exclude "*.tmp" --exclude "Thumbs.db" \
            -v --stats-one-line \
            --log-file="$LOG2" --use-json-log 2>&1; then
            SUCCESS=$((SUCCESS + 1))
            
            FILES2=$(grep -c '"msg":"Copied"' "$LOG2" 2>/dev/null || echo 0)
            TOTAL_FILES=$((TOTAL_FILES + FILES2))
            
            if [ "$FILES2" -gt 0 ]; then
              DETAILS2=$(grep '"msg":"Copied"' "$LOG2" | jq -r '"\(.object) (\(.size // 0) bytes)"' 2>/dev/null | head -5)
              FILE_LIST="${FILE_LIST}üìÇ C++ -> C++:\n${DETAILS2}\n"
            fi
            
            echo "Success! Files: $FILES2"
          else
            FAIL=$((FAIL + 1))
            echo "Failed!"
          fi
          
          echo "========================================"
          echo "Summary: Success=$SUCCESS, Failed=$FAIL, Files=$TOTAL_FILES"
          
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "fail=$FAIL" >> $GITHUB_OUTPUT
          echo "files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          
          # Save file list for notification
          echo "file_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FILE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update state.json
        run: |
          SUCCESS=${{ steps.sync.outputs.success }}
          FAIL=${{ steps.sync.outputs.fail }}
          FILES=${{ steps.sync.outputs.files }}
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          
          if [ ! -f state.json ]; then
            echo '{"stats":{"totalSyncs":0,"totalFiles":0,"success":0,"fail":0,"lastSync":""},"history":[]}' > state.json
          fi
          
          jq --arg now "$NOW" \
             --argjson files "$FILES" \
             --argjson success "$SUCCESS" \
             --argjson fail "$FAIL" \
             '.stats.totalSyncs += 1 |
              .stats.totalFiles += $files |
              .stats.success += $success |
              .stats.fail += $fail |
              .stats.lastSync = $now |
              .history = ([{"time": $now, "files": $files, "success": ($fail == 0), "duration": 30}] + .history) |
              .history = .history[:100]' state.json > tmp.json && mv tmp.json state.json
          
          cat state.json | jq '.stats'

      - name: Commit state.json
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add state.json
          git diff --staged --quiet || git commit -m "üìä Update stats $(date '+%H:%M')"
          git push || echo "Nothing to push"

      - name: Send Telegram notification
        if: always()
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "Telegram not configured"
            exit 0
          fi
          
          SUCCESS=${{ steps.sync.outputs.success }}
          FAIL=${{ steps.sync.outputs.fail }}
          FILES=${{ steps.sync.outputs.files }}
          FILE_LIST='${{ steps.sync.outputs.file_list }}'
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Fun greetings array
          GREETINGS=("Th·∫ßy ∆°i" "B√°o c√°o th·∫ßy" "Tin vui n√® th·∫ßy" "Th·∫ßy ∆°i th·∫ßy" "√ä th·∫ßy")
          EMOJIS=("üìö" "üéâ" "‚ú®" "üöÄ" "üí™" "üî•")
          GREETING=${GREETINGS[$((RANDOM % 5))]}
          EMOJI=${EMOJIS[$((RANDOM % 6))]}
          
          if [ "$FILES" -gt 0 ] || [ "$FAIL" -gt 0 ]; then
            if [ "$FAIL" -gt 0 ]; then
              MESSAGE="‚ö†Ô∏è ${GREETING}, c√≥ l·ªói khi sync r·ªìi! ‚ùå ${FAIL} folder b·ªã l·ªói. Ki·ªÉm tra GitHub Actions nh√©! Time: ${NOW}"
            else
              # Build detailed message
              MESSAGE="${EMOJI} ${GREETING}, c√≥ ${FILES} file m·ªõi ƒë∆∞·ª£c sync! ‚úÖ"
              
              if [ -n "$FILE_LIST" ] && [ "$FILE_LIST" != "" ]; then
                MESSAGE="${MESSAGE}

üìã Chi ti·∫øt:
${FILE_LIST}"
              fi
              
              MESSAGE="${MESSAGE}
‚è∞ ${NOW}
üíæ D·ªØ li·ªáu an to√†n r·ªìi nha! ÔøΩ"
            fi
            
            # Send with proper encoding
            curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
              --data-urlencode "chat_id=${CHAT_ID}" \
              --data-urlencode "text=${MESSAGE}"
          fi
