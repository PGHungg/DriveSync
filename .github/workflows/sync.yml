name: Google Drive Auto Sync

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
  repository_dispatch:
    types: [sync-trigger]

concurrency:
  group: sync-gdrive
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install rclone
        run: |
          curl -s https://rclone.org/install.sh | sudo bash
          rclone version | head -1

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.RCLONE_CONFIG }}' > ~/.config/rclone/rclone.conf

      - name: Sync folders
        id: sync
        continue-on-error: true
        env:
          SYNC_PAIRS: ${{ secrets.SYNC_FOLDERS }}
        run: |
          echo "Starting sync..."
          
          TOTAL=0
          LOG1="/tmp/sync1.log"
          LOG2="/tmp/sync2.log"
          FILELIST="/tmp/files.txt"
          > "$FILELIST"
          
          # Parse pairs
          PAIR1=$(echo "$SYNC_PAIRS" | cut -d',' -f1)
          PAIR2=$(echo "$SYNC_PAIRS" | cut -d',' -f2)
          
          # Sync pair 1
          if [ -n "$PAIR1" ]; then
            SRC1=$(echo "$PAIR1" | cut -d':' -f1)
            DST1=$(echo "$PAIR1" | cut -d':' -f2)
            echo "Pair 1: $SRC1 -> $DST1"
            
            # List source files
            echo "Files in source $SRC1:"
            rclone lsf "gdrive:${SRC1}" 2>&1 || true
            
            # List dest files BEFORE sync
            echo "Files in dest $DST1 BEFORE:"
            rclone lsf "gdrive:${DST1}" 2>&1 || true
            BEFORE1=$(rclone lsf "gdrive:${DST1}" 2>/dev/null | wc -l)
            
            # Do the sync
            rclone copy "gdrive:${SRC1}" "gdrive:${DST1}" \
              --exclude "*.tmp" --exclude "Thumbs.db" \
              -v --stats-one-line --stats 0 --retries 3 2>&1 | tee "$LOG1" || true
            
            # Parse rclone log to find copied files (Pair 1)
            C1=$(grep -c ": Copied" "$LOG1" || true)
            echo "Pair 1: Copied=$C1"
            
            if [ "$C1" -gt 0 ]; then
              echo "ðŸ“¦ $SRC1 -> $DST1" >> "$FILELIST"
              grep ": Copied" "$LOG1" | sed -E 's/.* : (.*): Copied.*/  - \1/' | head -10 >> "$FILELIST" || true
              echo "" >> "$FILELIST"
            fi
            TOTAL=$((TOTAL + C1))
          fi
          
          # Sync pair 2
          if [ -n "$PAIR2" ]; then
            SRC2=$(echo "$PAIR2" | cut -d':' -f1)
            DST2=$(echo "$PAIR2" | cut -d':' -f2)
            echo "Pair 2: $SRC2 -> $DST2"
            
            # Sync with logging
            rclone copy "gdrive:${SRC2}" "gdrive:${DEST2}" \
              --exclude "*.tmp" --exclude "Thumbs.db" \
              -v --stats-one-line --stats 0 --retries 3 2>&1 | tee "$LOG2" || true
            
            C2=$(grep -c ": Copied" "$LOG2" || true)
            echo "Pair 2: Copied=$C2"
            
            if [ "$C2" -gt 0 ]; then
              echo "ðŸ“¦ $SRC2 -> $DST2" >> "$FILELIST"
              grep ": Copied" "$LOG2" | sed -E 's/.* : (.*): Copied.*/  - \1/' | head -10 >> "$FILELIST" || true
              echo "" >> "$FILELIST"
            fi
            TOTAL=$((TOTAL + C2))
          fi
          
          echo "TOTAL FILES COPIED: $TOTAL"
          echo "files=$TOTAL" >> $GITHUB_OUTPUT
          
          # Prepare content for notification (preserve newlines)
          if [ -s "$FILELIST" ]; then
             CONTENT=$(cat "$FILELIST")
             # Use base64 to safeguard multiline strings in GitHub Actions
             EncodedContent=$(echo "$CONTENT" | base64 -w 0)
             echo "filenames=$EncodedContent" >> $GITHUB_OUTPUT
          else
             echo "filenames=" >> $GITHUB_OUTPUT
          fi

      - name: Update state.json
        if: always()
        run: |
          FILES="${{ steps.sync.outputs.files }}"
          NOW=$(TZ='Asia/Ho_Chi_Minh' date '+%Y-%m-%d %H:%M:%S')
          FILES=${FILES:-0}
          
          echo "Updating state.json with $FILES files at $NOW"
          
          # Only create if not exists (Fix Reset Bug)
          if [ ! -f state.json ]; then
            echo '{"stats":{"totalSyncs":0,"totalFiles":0,"lastSync":""},"history":[]}' > state.json
          fi
          
          # Read file details if available
          if [ -s /tmp/files.txt ]; then
            DETAILS=$(cat /tmp/files.txt | head -c 500) # Limit size
          else
            DETAILS=""
          fi
          
          # Update existing (Should always exist now)
          if [ -f state.json ]; then
            jq --arg now "$NOW" \
               --argjson files "$FILES" \
               --arg details "$DETAILS" \
               '.stats.totalSyncs = (.stats.totalSyncs // 0) + 1 | 
                .stats.totalFiles = (.stats.totalFiles // 0) + $files | 
                .stats.lastSync = $now | 
                .history = ([{"time": $now, "files": $files, "details": $details}] + (.history // [])) | 
                .history = .history[:50]' state.json > tmp.json && mv tmp.json state.json
          fi
          
          cat state.json

      - name: Commit state.json
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add state.json
          git diff --staged --quiet || git commit -m "Sync $(date '+%H:%M')"
          git push || true

      - name: Send Telegram notification
        if: always()
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Re-read outputs from sync step
          FILES="${{ steps.sync.outputs.files }}"
          FILENAMES="${{ steps.sync.outputs.filenames }}"
          NOW=$(TZ='Asia/Ho_Chi_Minh' date '+%Y-%m-%d %H:%M:%S')

          # Logic: Gá»­i khi cÃ³ file HOáº¶C khi cháº¡y thá»§ cÃ´ng (repository_dispatch)
          FORCE_NOTIFY="false"
          if [ "${{ github.event_name }}" == "repository_dispatch" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             FORCE_NOTIFY="true"
          fi

          if [ "$FILES" != "0" ] && [ -n "$FILES" ]; then
             SHOULD_SEND="true"
          elif [ "$FORCE_NOTIFY" == "true" ]; then
             SHOULD_SEND="true"
          else
             SHOULD_SEND="false"
          fi

          if [ "$SHOULD_SEND" == "true" ]; then
            # Decode content
            if [ -n "$FILENAMES" ]; then
               FILE_CONTENT=$(echo "$FILENAMES" | base64 -d)
            else
               FILE_CONTENT=""
            fi
            
            MESSAGE="ðŸš€ *Sync Report* "$'\n'"ðŸ•’ ${NOW}"$'\n\n'"${FILE_CONTENT}"$'\n'"---"$'\n'"ðŸ’¡ /sync â€¢ /status"
            
            # Send to Telegram
            curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d text="${MESSAGE}" \
              -d parse_mode="Markdown"
          else
            echo "No files synced. Skipping notification."
          fi
          # End of script
