name: Google Drive Auto Sync

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install rclone
        run: |
          curl -s https://rclone.org/install.sh | sudo bash
          rclone version | head -1

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.RCLONE_CONFIG }}' > ~/.config/rclone/rclone.conf
          echo "Testing rclone config..."
          rclone listremotes || echo "Config test done"

      - name: Sync folders
        id: sync
        continue-on-error: true
        env:
          SYNC_PAIRS: ${{ secrets.SYNC_FOLDERS }}
        run: |
          set +e  # Don't exit on error
          echo "Starting sync at $(date)"
          
          SUCCESS=0
          FAIL=0
          TOTAL_FILES=0
          
          # Check if SYNC_PAIRS is set
          if [ -z "$SYNC_PAIRS" ]; then
            echo "ERROR: SYNC_FOLDERS secret not set!"
            echo "success=0" >> $GITHUB_OUTPUT
            echo "fail=1" >> $GITHUB_OUTPUT
            echo "files=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Sync pairs: $SYNC_PAIRS"
          
          # Parse and sync each pair
          IFS=',' read -ra PAIRS <<< "$SYNC_PAIRS"
          echo "Found ${#PAIRS[@]} folder pairs"
          
          for i in "${!PAIRS[@]}"; do
            PAIR="${PAIRS[$i]}"
            SRC=$(echo "$PAIR" | cut -d':' -f1)
            DST=$(echo "$PAIR" | cut -d':' -f2)
            
            echo ""
            echo "========================================"
            echo "Pair $((i+1)): '$SRC' -> '$DST'"
            echo "========================================"
            
            LOG="/tmp/sync${i}.log"
            rm -f "$LOG"
            
            # Run rclone copy with verbose output
            echo "Running: rclone copy 'gdrive:${SRC}' 'gdrive:${DST}'"
            
            if rclone copy "gdrive:${SRC}" "gdrive:${DST}" \
              --exclude "*.tmp" \
              --exclude "~$*" \
              --exclude "Thumbs.db" \
              --exclude ".DS_Store" \
              --exclude "desktop.ini" \
              -v \
              --stats=5s \
              --stats-one-line \
              --log-file="$LOG" \
              --use-json-log \
              --retries 3 \
              --low-level-retries 10 \
              --timeout 60s \
              --contimeout 30s 2>&1; then
              
              SUCCESS=$((SUCCESS + 1))
              
              # Count copied files
              FILES_COUNT=$(grep -c '"msg":"Copied"' "$LOG" 2>/dev/null || echo 0)
              TOTAL_FILES=$((TOTAL_FILES + FILES_COUNT))
              
              echo "‚úÖ Success! Copied $FILES_COUNT files"
              
              # Show what was copied
              if [ "$FILES_COUNT" -gt 0 ]; then
                echo "Files copied:"
                grep '"msg":"Copied"' "$LOG" | jq -r '.object' 2>/dev/null | head -10
              fi
            else
              FAIL=$((FAIL + 1))
              echo "‚ùå Failed!"
              echo "Error log:"
              tail -20 "$LOG" 2>/dev/null || echo "No log available"
            fi
          done
          
          echo ""
          echo "========================================"
          echo "SUMMARY: Success=$SUCCESS, Failed=$FAIL, Files=$TOTAL_FILES"
          echo "========================================"
          
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "fail=$FAIL" >> $GITHUB_OUTPUT
          echo "files=$TOTAL_FILES" >> $GITHUB_OUTPUT

      - name: Update state.json
        if: always()
        run: |
          SUCCESS="${{ steps.sync.outputs.success }}"
          FAIL="${{ steps.sync.outputs.fail }}"
          FILES="${{ steps.sync.outputs.files }}"
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Default values if empty
          SUCCESS=${SUCCESS:-0}
          FAIL=${FAIL:-0}
          FILES=${FILES:-0}
          
          if [ ! -f state.json ]; then
            echo '{"stats":{"totalSyncs":0,"totalFiles":0,"success":0,"fail":0,"lastSync":""},"history":[]}' > state.json
          fi
          
          jq --arg now "$NOW" \
             --argjson files "$FILES" \
             --argjson success "$SUCCESS" \
             --argjson fail "$FAIL" \
             '.stats.totalSyncs += 1 |
              .stats.totalFiles += $files |
              .stats.success += $success |
              .stats.fail += $fail |
              .stats.lastSync = $now |
              .history = ([{"time": $now, "files": $files, "success": ($fail == 0), "duration": 30}] + .history) |
              .history = .history[:100]' state.json > tmp.json && mv tmp.json state.json
          
          echo "Updated state:"
          cat state.json | jq '.stats'

      - name: Commit state.json
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add state.json
          git diff --staged --quiet || git commit -m "Sync $(date '+%H:%M')"
          git push || echo "Nothing to push"

      - name: Send Telegram notification
        if: always()
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "Telegram not configured"
            exit 0
          fi
          
          SUCCESS="${{ steps.sync.outputs.success }}"
          FAIL="${{ steps.sync.outputs.fail }}"
          FILES="${{ steps.sync.outputs.files }}"
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Default values
          SUCCESS=${SUCCESS:-0}
          FAIL=${FAIL:-0}
          FILES=${FILES:-0}
          
          # Always notify (for debugging)
          if [ "$FAIL" -gt 0 ]; then
            MESSAGE="‚ö†Ô∏è Sync error! ${FAIL} folder(s) failed. Check GitHub Actions. Time: ${NOW}"
          elif [ "$FILES" -gt 0 ]; then
            MESSAGE="‚úÖ Synced ${FILES} file(s) successfully! Time: ${NOW}"
          else
            MESSAGE="üîÑ Sync completed. No new files. Time: ${NOW}"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=${MESSAGE}"
          
          echo "Notification sent!"
