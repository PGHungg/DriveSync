name: Google Drive Auto Sync

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install rclone
        run: |
          curl -s https://rclone.org/install.sh | sudo bash
          rclone version | head -1

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.RCLONE_CONFIG }}' > ~/.config/rclone/rclone.conf

      - name: Sync folders
        id: sync
        continue-on-error: true
        env:
          SYNC_PAIRS: ${{ secrets.SYNC_FOLDERS }}
        run: |
          echo "Starting sync..."
          
          TOTAL=0
          LOG1="/tmp/sync1.log"
          LOG2="/tmp/sync2.log"
          FILELIST="/tmp/files.txt"
          > "$FILELIST"
          
          # Parse pairs
          PAIR1=$(echo "$SYNC_PAIRS" | cut -d',' -f1)
          PAIR2=$(echo "$SYNC_PAIRS" | cut -d',' -f2)
          
          # Sync pair 1
          if [ -n "$PAIR1" ]; then
            SRC1=$(echo "$PAIR1" | cut -d':' -f1)
            DST1=$(echo "$PAIR1" | cut -d':' -f2)
            echo "Pair 1: $SRC1 -> $DST1"
            
            # List source files
            echo "Files in source $SRC1:"
            rclone lsf "gdrive:${SRC1}" 2>&1 || true
            
            # List dest files BEFORE sync
            echo "Files in dest $DST1 BEFORE:"
            rclone lsf "gdrive:${DST1}" 2>&1 || true
            BEFORE1=$(rclone lsf "gdrive:${DST1}" 2>/dev/null | wc -l)
            
            # Do the sync
            rclone copy "gdrive:${SRC1}" "gdrive:${DST1}" \
              --exclude "*.tmp" --exclude "Thumbs.db" \
              -v --stats-one-line --stats 0 --retries 3 2>&1 | tee "$LOG1" || true
            
            # List dest files AFTER sync
            AFTER1=$(rclone lsf "gdrive:${DST1}" 2>/dev/null | wc -l)
            C1=$((AFTER1 - BEFORE1))
            if [ "$C1" -lt 0 ]; then C1=0; fi
            
            echo "Pair 1: Before=$BEFORE1, After=$AFTER1, Copied=$C1"
            TOTAL=$((TOTAL + C1))
            
            # Get file names from source (for notification)
            if [ "$C1" -gt 0 ]; then
              rclone lsf "gdrive:${SRC1}" 2>/dev/null | head -10 >> "$FILELIST" || true
            fi
          fi
          
          # Sync pair 2
          if [ -n "$PAIR2" ]; then
            SRC2=$(echo "$PAIR2" | cut -d':' -f1)
            DST2=$(echo "$PAIR2" | cut -d':' -f2)
            echo "Pair 2: $SRC2 -> $DST2"
            
            # Count dest files BEFORE sync
            BEFORE2=$(rclone lsf "gdrive:${DST2}" 2>/dev/null | wc -l)
            
            # Do the sync
            rclone copy "gdrive:${SRC2}" "gdrive:${DST2}" \
              --exclude "*.tmp" --exclude "Thumbs.db" \
              -v --stats-one-line --stats 0 --retries 3 2>&1 | tee "$LOG2" || true
            
            # Count dest files AFTER sync
            AFTER2=$(rclone lsf "gdrive:${DST2}" 2>/dev/null | wc -l)
            C2=$((AFTER2 - BEFORE2))
            if [ "$C2" -lt 0 ]; then C2=0; fi
            
            echo "Pair 2: Before=$BEFORE2, After=$AFTER2, Copied=$C2"
            TOTAL=$((TOTAL + C2))
            
            # Get file names for notification
            if [ "$C2" -gt 0 ]; then
              rclone lsf "gdrive:${SRC2}" 2>/dev/null | head -10 >> "$FILELIST" || true
            fi
          fi
          
          echo "TOTAL FILES COPIED: $TOTAL"
          echo "files=$TOTAL" >> $GITHUB_OUTPUT
          
          # Lưu danh sách file (tối đa 10 file để tránh tin nhắn quá dài)
          NAMES=$(head -10 "$FILELIST" | tr '\n' '|')
          echo "filenames=$NAMES" >> $GITHUB_OUTPUT

      - name: Update state.json
        if: always()
        run: |
          FILES="${{ steps.sync.outputs.files }}"
          NOW=$(TZ='Asia/Ho_Chi_Minh' date '+%Y-%m-%d %H:%M:%S')
          FILES=${FILES:-0}
          
          echo "Updating state.json with $FILES files at $NOW"
          
          # Reset to simple format if needed
          cat > state.json << 'EOF'
          {"stats":{"totalSyncs":0,"totalFiles":0,"lastSync":""},"history":[]}
          EOF
          
          # Hoặc update existing
          if [ -f state.json ]; then
            jq --arg now "$NOW" --argjson files "$FILES" \
               '.stats.totalSyncs = (.stats.totalSyncs // 0) + 1 | 
                .stats.totalFiles = (.stats.totalFiles // 0) + $files | 
                .stats.lastSync = $now | 
                .history = ([{"time": $now, "files": $files}] + (.history // [])) | 
                .history = .history[:50]' state.json > tmp.json && mv tmp.json state.json
          fi
          
          cat state.json

      - name: Commit state.json
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add state.json
          git diff --staged --quiet || git commit -m "Sync $(date '+%H:%M')"
          git push || true

      - name: Send Telegram notification
        if: always()
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TOKEN" ] || [ -z "$CHAT_ID" ]; then
            exit 0
          fi
          
          FILES="${{ steps.sync.outputs.files }}"
          FILENAMES="${{ steps.sync.outputs.filenames }}"
          NOW=$(TZ='Asia/Ho_Chi_Minh' date '+%H:%M:%S')
          FILES=${FILES:-0}
          
          # Gửi thông báo khi có file mới
          if [ "$FILES" != "0" ] && [ -n "$FILES" ]; then
            # Nhiều kiểu chào ngẫu nhiên
            GREETINGS=(
              "Thầy ơi có file mới"
              "Đại ca ơi, có file mới"
              "file vừa sync xong"
            )
            GREETING="${GREETINGS[$((RANDOM % ${#GREETINGS[@]}))]}"
            
            # Tạo danh sách file
            FILELIST=""
            if [ -n "$FILENAMES" ]; then
              IFS='|' read -ra NAMES <<< "$FILENAMES"
              for name in "${NAMES[@]}"; do
                if [ -n "$name" ]; then
                  FILELIST="${FILELIST}"$'\n'"- ${name}"
                fi
              done
            fi
            
            MESSAGE="${GREETING}"$'\n'"Sync ${FILES} file luc ${NOW}${FILELIST}"
            
            curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
              --data-urlencode "chat_id=${CHAT_ID}" \
              --data-urlencode "text=${MESSAGE}"
          fi
