name: Google Drive Auto Sync

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install rclone
        run: |
          curl -s https://rclone.org/install.sh | sudo bash
          rclone version | head -1

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.RCLONE_CONFIG }}' > ~/.config/rclone/rclone.conf
          rclone listremotes

      - name: Sync folders
        id: sync
        continue-on-error: true
        env:
          SYNC_PAIRS: ${{ secrets.SYNC_FOLDERS }}
        run: |
          echo "Starting sync at $(date)"
          
          SUCCESS=0
          FAIL=0
          TOTAL_FILES=0
          
          if [ -z "$SYNC_PAIRS" ]; then
            echo "ERROR: SYNC_FOLDERS secret not set!"
            echo "success=0" >> $GITHUB_OUTPUT
            echo "fail=1" >> $GITHUB_OUTPUT
            echo "files=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Sync pairs: $SYNC_PAIRS"
          
          # Split by comma
          echo "$SYNC_PAIRS" | tr ',' '\n' | while read PAIR; do
            if [ -z "$PAIR" ]; then
              continue
            fi
            
            SRC=$(echo "$PAIR" | cut -d':' -f1)
            DST=$(echo "$PAIR" | cut -d':' -f2)
            
            echo ""
            echo "========================================"
            echo "Syncing: '$SRC' -> '$DST'"
            echo "========================================"
            
            LOG="/tmp/sync_$(echo $SRC | tr ' ' '_').log"
            rm -f "$LOG"
            
            # List source folder first
            echo "Checking source folder..."
            rclone lsf "gdrive:${SRC}" --max-depth 1 2>&1 | head -5 || echo "Could not list source"
            
            echo "Running rclone copy..."
            if rclone copy "gdrive:${SRC}" "gdrive:${DST}" \
              --exclude "*.tmp" \
              --exclude "~\$*" \
              --exclude "Thumbs.db" \
              -v \
              --stats-one-line \
              --log-file="$LOG" \
              --use-json-log \
              --retries 3 2>&1; then
              
              echo "Sync completed for this pair"
              
              COPIED=$(grep -c '"msg":"Copied"' "$LOG" 2>/dev/null || echo "0")
              echo "Files copied: $COPIED"
              
              if [ "$COPIED" != "0" ]; then
                grep '"msg":"Copied"' "$LOG" | jq -r '.object' 2>/dev/null | head -5
              fi
            else
              echo "Sync failed for this pair!"
              tail -10 "$LOG" 2>/dev/null
            fi
            
            echo "========================================"
          done
          
          # Re-count from logs
          TOTAL_COPIED=0
          for logfile in /tmp/sync_*.log; do
            if [ -f "$logfile" ]; then
              COUNT=$(grep -c '"msg":"Copied"' "$logfile" 2>/dev/null || true)
              TOTAL_COPIED=$((TOTAL_COPIED + COUNT))
            fi
          done
          
          echo ""
          echo "FINAL SUMMARY"
          echo "Total files copied: $TOTAL_COPIED"
          
          echo "files=$TOTAL_COPIED" >> $GITHUB_OUTPUT

      - name: Update state.json
        if: always()
        run: |
          FILES="${{ steps.sync.outputs.files }}"
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          FILES=${FILES:-0}
          
          if [ ! -f state.json ]; then
            echo '{"stats":{"totalSyncs":0,"totalFiles":0,"success":0,"fail":0,"lastSync":""},"history":[]}' > state.json
          fi
          
          jq --arg now "$NOW" --argjson files "$FILES" \
             '.stats.totalSyncs += 1 | .stats.totalFiles += $files | .stats.lastSync = $now | 
              .history = ([{"time": $now, "files": $files, "success": true}] + .history) | 
              .history = .history[:50]' state.json > tmp.json && mv tmp.json state.json

      - name: Commit state.json
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add state.json
          git diff --staged --quiet || git commit -m "Sync $(date '+%H:%M')"
          git push || true

      - name: Send Telegram notification
        if: always()
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TOKEN" ] || [ -z "$CHAT_ID" ]; then
            exit 0
          fi
          
          FILES="${{ steps.sync.outputs.files }}"
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          FILES=${FILES:-0}
          
          if [ "$FILES" = "0" ]; then
            MESSAGE="üîÑ Sync xong. Kh√¥ng c√≥ file m·ªõi. Time: ${NOW}"
          else
            MESSAGE="‚úÖ ƒê√£ sync ${FILES} file m·ªõi! Time: ${NOW}"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=${MESSAGE}"
