name: Google Drive Auto Sync

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install rclone and jq
        run: |
          curl -s https://rclone.org/install.sh | sudo bash
          sudo apt-get install -y jq
          rclone version | head -1

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          cat << 'EOF' > ~/.config/rclone/rclone.conf
          ${{ secrets.RCLONE_CONFIG }}
          EOF

      - name: Sync folders
        id: sync
        run: |
          echo "Starting sync..."
          
          TOTAL_FILES=0
          SUCCESS=0
          FAIL=0
          DETAILS=""
          
          # Folder 1: 01 -> 02
          echo "========================================"
          echo "Syncing: 01 -> 02"
          if rclone copy "gdrive:01" "gdrive:02" \
            --exclude "*.tmp" --exclude "~\$*" --exclude "Thumbs.db" \
            -v --stats-one-line 2>&1; then
            SUCCESS=$((SUCCESS + 1))
            DETAILS="${DETAILS}‚úÖ test: OK\n"
            echo "Success!"
          else
            FAIL=$((FAIL + 1))
            DETAILS="${DETAILS}‚ùå test: Failed\n"
            echo "Failed!"
          fi
          
          # Folder 2: C++ T10 2025 -> C++
          echo "========================================"
          echo "Syncing: C++ T10 2025 -> C++"
          if rclone copy "gdrive:C++ T10 2025" "gdrive:C++" \
            --exclude "*.tmp" --exclude "~\$*" --exclude "Thumbs.db" \
            -v --stats-one-line 2>&1; then
            SUCCESS=$((SUCCESS + 1))
            DETAILS="${DETAILS}‚úÖ cpp: OK\n"
            echo "Success!"
          else
            FAIL=$((FAIL + 1))
            DETAILS="${DETAILS}‚ùå cpp: Failed\n"
            echo "Failed!"
          fi
          
          echo "========================================"
          echo "Summary: Success=$SUCCESS, Failed=$FAIL"
          
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "fail=$FAIL" >> $GITHUB_OUTPUT
          echo "details<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        if: always()
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          if [ -z "$TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "Telegram not configured"
            exit 0
          fi
          
          SUCCESS="${{ steps.sync.outputs.success }}"
          FAIL="${{ steps.sync.outputs.fail }}"
          DETAILS="${{ steps.sync.outputs.details }}"
          
          if [ "$FAIL" -gt 0 ]; then
            STATUS="‚ö†Ô∏è Sync c√≥ l·ªói"
          else
            STATUS="‚úÖ Sync th√†nh c√¥ng"
          fi
          
          MESSAGE="üîÑ Drive Sync Report

$STATUS

‚úÖ Success: $SUCCESS
‚ùå Failed: $FAIL
‚è∞ $(date '+%Y-%m-%d %H:%M:%S')

$DETAILS"
          
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "text=${MESSAGE}" || echo "Telegram send failed"
