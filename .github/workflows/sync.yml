name: Google Drive Auto Sync

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
  repository_dispatch:
    types: [sync-trigger]

concurrency:
  group: sync-gdrive
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install rclone
        run: |
          curl -s https://rclone.org/install.sh | sudo bash
          rclone version | head -1

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.RCLONE_CONFIG }}' > ~/.config/rclone/rclone.conf

      - name: Sync folders
        id: sync
        continue-on-error: true
        env:
          SYNC_PAIRS: ${{ secrets.SYNC_FOLDERS }}
        run: |
          echo "Starting sync..."
          
          TOTAL=0
          FILELIST="/tmp/files.txt"
          > "$FILELIST"
          
          # Parse pairs
          PAIR1=$(echo "$SYNC_PAIRS" | cut -d',' -f1)
          PAIR2=$(echo "$SYNC_PAIRS" | cut -d',' -f2)
          
          # Sync pair 1
          if [ -n "$PAIR1" ]; then
            SRC1=$(echo "$PAIR1" | cut -d':' -f1)
            DST1=$(echo "$PAIR1" | cut -d':' -f2)
            echo "Pair 1: $SRC1 -> $DST1"
            
            # Sync v·ªõi verbose log
            rclone copy "gdrive:${SRC1}" "gdrive:${DST1}" \
              --exclude "*.tmp" --exclude "Thumbs.db" \
              -v 2>&1 | tee /tmp/log1.txt || true
            
            # ƒê·∫øm file copied
            C1=$(grep -c ": Copied" /tmp/log1.txt 2>/dev/null || echo "0")
            C1=${C1:-0}
            echo "Pair 1 copied: $C1"
            
            if [ "$C1" -gt 0 ]; then
              echo "üì¶ $SRC1 -> $DST1" >> "$FILELIST"
              grep ": Copied" /tmp/log1.txt | sed 's/.*: Copied.*//' | sed 's/.*INFO  : /  - /' | head -5 >> "$FILELIST"
            fi
            TOTAL=$((TOTAL + C1))
          fi
          
          # Sync pair 2
          if [ -n "$PAIR2" ] && [ "$PAIR2" != "$PAIR1" ]; then
            SRC2=$(echo "$PAIR2" | cut -d':' -f1)
            DST2=$(echo "$PAIR2" | cut -d':' -f2)
            echo "Pair 2: $SRC2 -> $DST2"
            
            rclone copy "gdrive:${SRC2}" "gdrive:${DST2}" \
              --exclude "*.tmp" --exclude "Thumbs.db" \
              -v 2>&1 | tee /tmp/log2.txt || true
            
            C2=$(grep -c ": Copied" /tmp/log2.txt 2>/dev/null || echo "0")
            C2=${C2:-0}
            echo "Pair 2 copied: $C2"
            
            if [ "$C2" -gt 0 ]; then
              echo "üì¶ $SRC2 -> $DST2" >> "$FILELIST"
              grep ": Copied" /tmp/log2.txt | sed 's/.*: Copied.*//' | sed 's/.*INFO  : /  - /' | head -5 >> "$FILELIST"
            fi
            TOTAL=$((TOTAL + C2))
          fi
          
          echo "=== TOTAL: $TOTAL files ==="
          echo "files=$TOTAL" >> $GITHUB_OUTPUT
          
          # Save file list
          cat "$FILELIST" || true
          cp "$FILELIST" /tmp/notify.txt || true

      - name: Update state.json
        if: always()
        run: |
          FILES="${{ steps.sync.outputs.files }}"
          FILES=${FILES:-0}
          NOW=$(TZ='Asia/Ho_Chi_Minh' date '+%Y-%m-%d %H:%M:%S')
          
          echo "Updating state: $FILES files at $NOW"
          
          # Create if not exists
          if [ ! -f state.json ]; then
            echo '{"stats":{"totalSyncs":0,"totalFiles":0,"lastSync":""},"history":[]}' > state.json
          fi
          
          # Update with jq
          jq --arg now "$NOW" --argjson files "$FILES" \
             '.stats.totalSyncs += 1 | .stats.totalFiles += $files | .stats.lastSync = $now | .history = ([{"time": $now, "files": $files}] + .history)[:50]' \
             state.json > tmp.json && mv tmp.json state.json
          
          cat state.json

      - name: Commit state
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add state.json
          git diff --staged --quiet || git commit -m "Sync $(TZ='Asia/Ho_Chi_Minh' date '+%H:%M')"
          git push || true

      - name: Telegram notification
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          FILES="${{ steps.sync.outputs.files }}"
          FILES=${FILES:-0}
          NOW=$(TZ='Asia/Ho_Chi_Minh' date '+%H:%M:%S')
          EVENT="${{ github.event_name }}"
          
          echo "Files: $FILES, Event: $EVENT"
          
          # Determine if we should send
          SEND="no"
          if [ "$FILES" -gt 0 ]; then
            SEND="yes"
          elif [ "$EVENT" = "repository_dispatch" ] || [ "$EVENT" = "workflow_dispatch" ]; then
            SEND="yes"
          fi
          
          if [ "$SEND" = "yes" ]; then
            # Build message
            if [ "$FILES" -gt 0 ] && [ -f /tmp/notify.txt ]; then
              DETAILS=$(cat /tmp/notify.txt | head -20)
              MSG="üöÄ *Sync Complete!*
üïí $NOW
üìÅ $FILES file(s) copied

$DETAILS

---
üí° /sync ‚Ä¢ /status"
            else
              MSG="‚úÖ *Sync Complete!*
üïí $NOW
üìÅ No new files

---
üí° /sync ‚Ä¢ /status"
            fi
            
            # Send
            if [ -n "$BOT_TOKEN" ] && [ -n "$CHAT_ID" ]; then
              curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
                -d "chat_id=${CHAT_ID}" \
                -d "text=${MSG}" \
                -d "parse_mode=Markdown" || echo "Curl failed"
            else
              echo "Missing BOT_TOKEN or CHAT_ID!"
            fi
          else
            echo "Skipping notification (scheduled run with 0 files)"
          fi
