name: Google Drive Auto Sync

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
  repository_dispatch:
    types: [sync-trigger]

concurrency:
  group: sync-gdrive
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install rclone
        run: |
          curl -s https://rclone.org/install.sh | sudo bash
          rclone version | head -1

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.RCLONE_CONFIG }}' > ~/.config/rclone/rclone.conf

      - name: Sync folders
        id: sync
        continue-on-error: true
        env:
          SYNC_PAIRS: ${{ secrets.SYNC_FOLDERS }}
        run: |
          echo "Starting sync..."
          
          TOTAL=0
          LOG1="/tmp/sync1.log"
          LOG2="/tmp/sync2.log"
          FILELIST="/tmp/files.txt"
          > "$FILELIST"
          
          # Parse pairs
          PAIR1=$(echo "$SYNC_PAIRS" | cut -d',' -f1)
          PAIR2=$(echo "$SYNC_PAIRS" | cut -d',' -f2)
          
          # Sync pair 1
          if [ -n "$PAIR1" ]; then
            SRC1=$(echo "$PAIR1" | cut -d':' -f1)
            DST1=$(echo "$PAIR1" | cut -d':' -f2)
            echo "Pair 1: $SRC1 -> $DST1"
            
            # List source files
            echo "Files in source $SRC1:"
            rclone lsf "gdrive:${SRC1}" 2>&1 || true
            
            # List dest files BEFORE sync
            echo "Files in dest $DST1 BEFORE:"
            rclone lsf "gdrive:${DST1}" 2>&1 || true
            BEFORE1=$(rclone lsf "gdrive:${DST1}" 2>/dev/null | wc -l)
            
            # Do the sync
            rclone copy "gdrive:${SRC1}" "gdrive:${DST1}" \
              --exclude "*.tmp" --exclude "Thumbs.db" \
              -v --stats-one-line --stats 0 --retries 3 2>&1 | tee "$LOG1" || true
            
            # Parse rclone log to find copied files (Pair 1)
            C1=$(grep -c ": Copied" "$LOG1" || true)
            echo "Pair 1: Copied=$C1"
            
            if [ "$C1" -gt 0 ]; then
              echo "üì¶ $SRC1 -> $DST1" >> "$FILELIST"
              grep ": Copied" "$LOG1" | sed -E 's/.* : (.*): Copied.*/  - \1/' | head -10 >> "$FILELIST" || true
              echo "" >> "$FILELIST"
            fi
            TOTAL=$((TOTAL + C1))
          fi
          
          # Sync pair 2
          if [ -n "$PAIR2" ]; then
            SRC2=$(echo "$PAIR2" | cut -d':' -f1)
            DST2=$(echo "$PAIR2" | cut -d':' -f2)
            echo "Pair 2: $SRC2 -> $DST2"
            
            # Sync with logging
            rclone copy "gdrive:${SRC2}" "gdrive:${DST2}" \
              --exclude "*.tmp" --exclude "Thumbs.db" \
              -v --stats-one-line --stats 0 --retries 3 2>&1 | tee "$LOG2" || true
            
            C2=$(grep -c ": Copied" "$LOG2" || true)
            echo "Pair 2: Copied=$C2"
            
            if [ "$C2" -gt 0 ]; then
              echo "üì¶ $SRC2 -> $DST2" >> "$FILELIST"
              grep ": Copied" "$LOG2" | sed -E 's/.* : (.*): Copied.*/  - \1/' | head -10 >> "$FILELIST" || true
              echo "" >> "$FILELIST"
            fi
            TOTAL=$((TOTAL + C2))
          fi
          
          echo "TOTAL FILES COPIED: $TOTAL"
          echo "files=$TOTAL" >> $GITHUB_OUTPUT
          
          # Prepare output
          if [ -s "$FILELIST" ]; then
             CONTENT=$(cat "$FILELIST")
          else
             CONTENT="‚úÖ Scan complete. No new files found."
          fi
          
          # Base64 encode
          EncodedContent=$(echo "$CONTENT" | base64 -w 0)
          echo "filenames=$EncodedContent" >> $GITHUB_OUTPUT

      - name: Update state.json
        if: always()
        run: |
          FILES="${{ steps.sync.outputs.files }}"
          # ... existing code ...

# ... (skip to notification step) ...

      - name: Send Telegram notification
        if: always()
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Re-read outputs
          FILES="${{ steps.sync.outputs.files }}"
          FILENAMES="${{ steps.sync.outputs.filenames }}"
          NOW=$(TZ='Asia/Ho_Chi_Minh' date '+%Y-%m-%d %H:%M:%S')

          # Force Notify on Manual Trigger
          SHOULD_SEND="false"
          if [ "$FILES" != "0" ] && [ -n "$FILES" ]; then
             SHOULD_SEND="true"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             SHOULD_SEND="true"
          fi

          if [ "$SHOULD_SEND" == "true" ]; then
            # Decode content
            if [ -n "$FILENAMES" ]; then
               FILE_CONTENT=$(echo "$FILENAMES" | base64 -d)
            else
               FILE_CONTENT="‚ö†Ô∏è No info available"
            fi
            
            MESSAGE="üöÄ *Sync Report* "$'\n'"üïí ${NOW}"$'\n\n'"${FILE_CONTENT}"$'\n'"---"$'\n'"üí° /sync ‚Ä¢ /status"
            
            # Send (Verify Token exists)
            if [ -n "$TOKEN" ]; then
                curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
                  -d chat_id="${CHAT_ID}" \
                  -d text="${MESSAGE}" \
                  -d parse_mode="Markdown"
            else
                echo "‚ùå Error: Missing TELEGRAM_BOT_TOKEN in GitHub Secrets!"
            fi
          fi
          # End of script
