name: Google Drive Auto Sync

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install rclone
        run: |
          curl -s https://rclone.org/install.sh | sudo bash
          rclone version | head -1

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.RCLONE_CONFIG }}' > ~/.config/rclone/rclone.conf

      - name: Sync folders
        id: sync
        env:
          SYNC_PAIRS: ${{ secrets.SYNC_FOLDERS }}
        run: |
          echo "Starting sync..."
          
          SUCCESS=0
          FAIL=0
          TOTAL_FILES=0
          FILE_LIST=""
          
          # Parse sync pairs from secret (format: "src1:dst1,src2:dst2")
          # Default if not set
          if [ -z "$SYNC_PAIRS" ]; then
            SYNC_PAIRS="folder1:folder2"
          fi
          
          IFS=',' read -ra PAIRS <<< "$SYNC_PAIRS"
          
          for i in "${!PAIRS[@]}"; do
            PAIR="${PAIRS[$i]}"
            SRC=$(echo "$PAIR" | cut -d':' -f1)
            DST=$(echo "$PAIR" | cut -d':' -f2)
            
            echo "========================================"
            echo "Syncing pair $((i+1))..."
            LOG="/tmp/sync${i}.log"
            
            if rclone copy "gdrive:${SRC}" "gdrive:${DST}" \
              --exclude "*.tmp" --exclude "Thumbs.db" \
              -v --stats-one-line \
              --log-file="$LOG" --use-json-log 2>&1; then
              SUCCESS=$((SUCCESS + 1))
              
              FILES_COUNT=$(grep -c '"msg":"Copied"' "$LOG" 2>/dev/null || echo 0)
              TOTAL_FILES=$((TOTAL_FILES + FILES_COUNT))
              
              if [ "$FILES_COUNT" -gt 0 ]; then
                DETAILS=$(grep '"msg":"Copied"' "$LOG" | jq -r '.object' 2>/dev/null | head -5)
                FILE_LIST="${FILE_LIST}Folder $((i+1)): ${FILES_COUNT} files\n"
              fi
              
              echo "Success! Files: $FILES_COUNT"
            else
              FAIL=$((FAIL + 1))
              echo "Failed!"
            fi
          done
          
          echo "========================================"
          echo "Summary: Success=$SUCCESS, Failed=$FAIL, Files=$TOTAL_FILES"
          
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "fail=$FAIL" >> $GITHUB_OUTPUT
          echo "files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          
          echo "file_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FILE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update state.json
        run: |
          SUCCESS=${{ steps.sync.outputs.success }}
          FAIL=${{ steps.sync.outputs.fail }}
          FILES=${{ steps.sync.outputs.files }}
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          
          if [ ! -f state.json ]; then
            echo '{"stats":{"totalSyncs":0,"totalFiles":0,"success":0,"fail":0,"lastSync":""},"history":[]}' > state.json
          fi
          
          jq --arg now "$NOW" \
             --argjson files "$FILES" \
             --argjson success "$SUCCESS" \
             --argjson fail "$FAIL" \
             '.stats.totalSyncs += 1 |
              .stats.totalFiles += $files |
              .stats.success += $success |
              .stats.fail += $fail |
              .stats.lastSync = $now |
              .history = ([{"time": $now, "files": $files, "success": ($fail == 0), "duration": 30}] + .history) |
              .history = .history[:100]' state.json > tmp.json && mv tmp.json state.json
          
          cat state.json | jq '.stats'

      - name: Commit state.json
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add state.json
          git diff --staged --quiet || git commit -m "Update $(date '+%H:%M')"
          git push || echo "Nothing to push"

      - name: Send Telegram notification
        if: always()
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "Telegram not configured"
            exit 0
          fi
          
          SUCCESS=${{ steps.sync.outputs.success }}
          FAIL=${{ steps.sync.outputs.fail }}
          FILES=${{ steps.sync.outputs.files }}
          FILE_LIST='${{ steps.sync.outputs.file_list }}'
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          
          GREETINGS=("Hey" "Hi" "Yo" "Hello")
          GREETING=${GREETINGS[$((RANDOM % 4))]}
          
          if [ "$FILES" -gt 0 ] || [ "$FAIL" -gt 0 ]; then
            if [ "$FAIL" -gt 0 ]; then
              MESSAGE="${GREETING}! Sync error: ${FAIL} failed. Time: ${NOW}"
            else
              MESSAGE="${GREETING}! ${FILES} files synced. Time: ${NOW}"
            fi
            
            curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
              --data-urlencode "chat_id=${CHAT_ID}" \
              --data-urlencode "text=${MESSAGE}"
          fi
